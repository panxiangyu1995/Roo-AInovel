# 小说框架工作流开发指南

本指南基于项目开发历程和经验总结，为新建或修改工作流模块提供详细步骤和最佳实践。遵循本指南可以确保工作流模块与系统其他部分保持一致性，并减少不必要的工作量。

## 目录

1. [工作流概述](#工作流概述)
2. [新建工作流流程](#新建工作流流程)
3. [修改现有工作流流程](#修改现有工作流流程)
4. [index.ts 更新指南](#indexts-更新指南)
5. [utils 目录更新指南](#utils-目录更新指南)
6. [最佳实践与注意事项](#最佳实践与注意事项)
7. [常见问题与解决方案](#常见问题与解决方案)

## 工作流概述

工作流模块是小说框架完善工具的核心组件，负责处理框架的特定部分（如角色设计、情节大纲等）。目前系统包含13个标准工作流：

1. 小说题材 (genre)
2. 角色设计 (character)
3. 情节大纲 (plot)
4. 世界观设定 (world)
5. 主题元素 (theme)
6. 章节规划 (chapter-outline)
7. 叙事风格 (style)
8. 写作手法 (writing-technique)
9. 市场定位 (market)
10. 系统设定 (tech)
11. 情感设计 (emotion)
12. 自我反思 (reflection)
13. 创作计划 (plan)

每个工作流都遵循统一的结构和交互模式，确保用户体验的一致性。

## 新建工作流流程

### 1. 创建工作流文件

1. 在 `src/core/tools/novel-framework-refine/workflows/` 目录下创建新的工作流文件，如 `new-workflow.ts`
2. 使用 `character.ts` 作为模板，包含以下基本结构：
   - 导入必要的模块和工具函数
   - 定义主工作流处理函数（如 `handleNewWorkflowWorkflow`）
   - 实现两套6选项系统（已有内容优化/新建内容）
   - 实现文件内容处理逻辑
   - 集成错误处理和内容验证

示例框架：

```typescript
import * as path from "path"
import * as fs from "fs/promises"
import { WorkflowParams } from "../types"
import { findSectionPosition } from "../utils/position"
import { safeExecute } from "../utils/error-handler"
import { prepareReplaceDiff, prepareAppendDiff } from "../utils/common"

export async function handleNewWorkflowWorkflow(params: WorkflowParams): Promise<boolean> {
    const { cline, filePath, frameworkContent, askFollowupQuestion } = params
    
    // 检查是否已存在相关内容
    const sectionPosition = findSectionPosition(frameworkContent, ["## 新工作流部分", "## 新部分标题"])
    
    const questionBlock = {
        // 准备选项内容
    }
    
    // 询问用户选择
    let success = false
    let continueInCurrentSection = false
    
    await askFollowupQuestion(
        questionBlock,
        async (result: string) => {
            // 处理用户选择
            
            return true  // 必须返回值
        }
    )
    
    return success || continueInCurrentSection
}
```

### 2. 更新 utils 目录中的支持文件

1. `types.ts`: 添加新工作流相关的配置接口
2. `generators.ts`: 添加生成新部分内容的函数
3. `position.ts`: 确保 `findSectionPosition` 函数能识别新部分的标题
4. `common.ts`: 在 `areaNames` 映射中添加新工作流的中文名称
5. `analysis.ts`: 添加分析新部分内容的逻辑
6. `diff-utils.ts`: 如需要，添加新部分的位置确定函数

### 3. 更新 index.ts 文件

1. 导入新工作流模块：
   ```typescript
   import { handleNewWorkflowWorkflow } from "./workflows/new-workflow"
   export { handleNewWorkflowWorkflow } from "./workflows/new-workflow"
   ```

2. 更新工作流映射表：
   ```typescript
   const workflowMap: Record<string, (params: any) => Promise<boolean>> = {
       // 现有工作流...
       'new-workflow': handleNewWorkflowWorkflow,
   }
   ```

3. 更新标准顺序数组：
   ```typescript
   const standardOrder = [
       // 现有顺序...
       "new-workflow",
   ]
   ```

4. 更新区域名称映射：
   ```typescript
   const areaNames: { [key: string]: string } = {
       // 现有映射...
       "new-workflow": "新工作流中文名称",
   }
   ```

5. 更新基本框架元素检查函数：
   ```typescript
   function checkEssentialSections(content: string) {
       // 添加新部分的检查...
   }
   ```

6. 更新通用选项创建函数：
   ```typescript
   function createGenericOption(area: string, areaName: string) {
       // 添加新部分的通用选项...
   }
   ```

7. 更新框架生成相关函数，确保包含新部分

## 修改现有工作流流程

### 1. 确定修改范围

1. 明确需要修改的工作流文件和相关功能
2. 检查该工作流与其他部分的依赖关系
3. 评估修改可能产生的影响范围

### 2. 修改工作流文件

1. 更新工作流处理函数，保持函数签名不变
2. 调整选项系统，确保仍然提供6个选项
3. 更新内容处理逻辑
4. 确保所有代码路径都有明确的返回值
5. 保持错误处理机制的一致性

### 3. 更新相关支持文件

根据修改的需要，更新 utils 目录下的相关文件：

1. 如修改了部分标题或结构，更新 `position.ts` 和 `diff-utils.ts`
2. 如修改了内容生成方式，更新 `generators.ts`
3. 如修改了配置参数，更新 `types.ts`
4. 如修改了名称或描述，更新 `common.ts` 中的映射

### 4. 同步更新 index.ts

1. 如修改了函数名称，更新导入语句和工作流映射表
2. 如修改了部分名称或描述，更新区域名称映射
3. 如改变了工作流的重要性或顺序，调整标准顺序数组

## index.ts 更新指南

`index.ts` 是系统的核心集成点，需要特别注意同步更新以下几个关键部分：

### 1. 导入和导出语句

```typescript
// 导入工作流
import { handleNewWorkflowWorkflow } from "./workflows/new-workflow"
// 导出工作流以供其他模块使用
export { handleNewWorkflowWorkflow } from "./workflows/new-workflow"
```

### 2. 工作流映射表

```typescript
const workflowMap: Record<string, (params: any) => Promise<boolean>> = {
    'genre': handleGenreWorkflow,
    'character': handleCharacterWorkflow,
    // ... 其他工作流
    'new-workflow': handleNewWorkflowWorkflow,
}
```

### 3. 标准顺序数组

```typescript
const standardOrder = [
    "genre",
    "character",
    "plot",
    // ... 其他工作流
    "new-workflow",
    "plan"  // 创作计划始终放在最后
]
```

### 4. 区域名称映射

```typescript
const areaNames: { [key: string]: string } = {
    genre: "小说题材",
    character: "角色设计",
    // ... 其他映射
    "new-workflow": "新工作流中文名称",
}
```

### 5. 基本框架元素检查

```typescript
function checkEssentialSections(content: string): { 
    allSectionsExist: boolean, 
    existingSections: string[],
    missingSections: string[]
} {
    // 检查各部分是否存在
    const characterExists = /## 主要角色|## 角色设计|## 角色列表/i.test(content)
    // ... 其他检查
    const newWorkflowExists = /## 新工作流部分|## 新部分标题/i.test(content)
    
    // 更新存在和缺失的部分列表
}
```

### 6. 通用选项创建

```typescript
function createGenericOption(area: string, areaName: string): RefinementOption {
    // ... 现有选项
    if (area === "new-workflow") {
        return {
            id: "add_new_workflow",
            title: `添加${areaName}`,
            description: "为框架添加新工作流部分的内容",
            area: "new-workflow"
        }
    }
    // ... 其他选项
}
```

### 7. 框架文件创建选项

确保 `createFrameworkFile` 函数中的选项列表包含新工作流：

```typescript
const options = [
    "1. 小说题材设定",
    // ... 其他选项
    "X. 新工作流部分",
    "13. 创作计划"
]
```

## utils 目录更新指南

utils 目录包含支持工作流运行的核心工具函数，需要同步更新以下文件：

### 1. types.ts

添加新工作流相关的配置接口：

```typescript
export interface NewWorkflowConfig {
    property1: string;
    property2: string[];
    // ... 其他属性
}
```

### 2. generators.ts

添加生成新部分内容的函数：

```typescript
export function generateNewWorkflowSection(config: NewWorkflowConfig): string {
    const { property1, property2 = [] } = config
    let content = '## 新工作流部分\n\n'
    
    if (property1) {
        content += `### 第一部分\n\n${property1}\n\n`
    } else {
        content += '### 第一部分\n\n*此处添加相关内容*\n\n'
    }
    
    if (property2.length > 0) {
        content += '### 第二部分\n\n' + property2.map(item => `- ${item}`).join('\n') + '\n\n'
    } else {
        content += '### 第二部分\n\n*此处添加相关内容*\n\n'
    }
    
    return content
}
```

按照重要性排序：

1. 剧情（plot）- 故事的核心
2. 世界观（world）- 故事的基础舞台
3. 主题（theme）- 作品的思想内核
4. 系统设定（system）- 特定类型小说的核心机制
5. 章节规划（chapter）- 内容的组织结构
6. 叙事风格（style）- 表达方式
7. 情感设计（emotion）- 情感层次和节奏
8. 市场定位（market）- 读者和商业考量
9. 自我反思（reflection）- 创作意图和期望
10. 创作计划（plan）- 实施时间安排，放在最后

### 3. position.ts

确保 `findSectionPosition` 函数能识别新部分的标题：

```typescript
export function findSectionPosition(content: string, sectionTitles: string[]): SectionPosition | null {
    // 现有逻辑...
}
```

### 4. common.ts

在 `areaNames` 映射中添加新工作流的中文名称：

```typescript
export function formatOptionsMessage(options: RefinementOption[]): string {
    // 按区域分组
    const areaMap: { [key: string]: RefinementOption[] } = {}
    const areaNames: { [key: string]: string } = {
        // 现有映射...
        "new-workflow": "新工作流中文名称",
    }
    
    // 现有逻辑...
}
```

### 5. analysis.ts

添加分析新部分内容的逻辑：

```typescript
export function analyzeFramework(content: string): RefinementOption[] {
    const options: RefinementOption[] = []
    
    // 现有分析逻辑...
    
    // 分析新工作流部分
    if (/## 新工作流部分|## 新部分标题/i.test(content)) {
        // 新部分存在，添加完善选项
        options.push({
            id: "new_workflow_option1",
            title: "完善新工作流的第一方面",
            description: "针对新工作流的第一个方面进行深入完善",
            area: "new-workflow"
        })
        
        // 更多选项...
    }
    
    // 现有逻辑...
    
    return options
}
```

### 6. diff-utils.ts

如需要，添加新部分的位置确定函数：

```typescript
export function determineNewWorkflowSectionPosition(content: string): {
    startLine: number;
    endLine: number;
} | null {
    const lines = content.split('\n')
    let inSection = false
    let startLine = -1
    let endLine = -1
    
    // 查找部分开始和结束位置的逻辑...
    
    return startLine >= 0 ? { startLine, endLine } : null
}
```

## 最佳实践与注意事项

### 代码结构与风格

1. **保持一致的函数签名**：所有工作流处理函数应遵循相同的参数结构和返回类型
2. **统一的错误处理**：使用 `safeExecute` 进行错误捕获和处理
3. **完整的返回值**：确保所有代码路径都有明确的返回值，解决TypeScript编译错误
4. **标准化内容处理**：统一使用 `findSectionPosition`、`prepareReplaceDiff` 等工具函数
5. **统一的选项系统**：所有工作流都应提供两套6选项系统（已有内容优化/新建内容）

### 用户交互设计

1. **一致的选项格式**：保持选项编号和描述风格的一致性
2. **清晰的分类标识**：使用"【区域名称】"格式标注选项所属的框架部分
3. **合理的选项组织**：按照标准顺序排列选项，使其符合创作逻辑
4. **完整的选项集**：确保每次询问都提供"继续完善"、"跳到下一步"和"切换到写作模式"三个基本选项
5. **友好的提示信息**：提供清晰、专业的提示，指导用户完成框架的各个部分

### 性能与效率

1. **避免重复代码**：合理使用工具函数，减少代码重复
2. **最小化更新范围**：修改时尽量将更改限制在必要的范围内
3. **保持依赖简单**：避免复杂的依赖关系，减少维护成本
4. **优化文件操作**：合理使用异步文件操作，避免阻塞主线程
5. **智能内容分析**：优化内容分析算法，提高选项生成的准确性和相关性

### 测试与维护

1. **全面测试**：修改后全面测试所有工作流，确保系统的完整功能
2. **记录变更**：在 LOG.md 中详细记录所有重要变更
3. **版本控制**：使用清晰的提交信息，便于追踪变更历史
4. **兼容性考虑**：在修改时考虑向后兼容性，避免破坏现有功能
5. **文档更新**：及时更新相关文档，确保文档与代码保持同步

## 常见问题与解决方案

### 1. TypeScript 编译错误: "Not all code paths return a value"

**问题**：工作流函数报告 TS-7030 错误，提示并非所有代码路径都返回值。

**解决方案**：
- 添加 `success` 变量跟踪操作是否成功
- 确保所有回调函数都有 `return true` 语句
- 使用 `return success || continueInCurrentSection` 作为工作流函数的最终返回值

### 2. 内容识别失败

**问题**：`findSectionPosition` 无法识别特定部分的标题。

**解决方案**：
- 确保传入 `findSectionPosition` 的标题数组包含所有可能的变体
- 检查正则表达式是否正确匹配目标标题
- 对于特殊格式的标题，考虑创建专门的位置确定函数

### 3. 工作流顺序问题

**问题**：新添加的工作流未按预期顺序显示在选项列表中。

**解决方案**：
- 检查 `standardOrder` 数组中的顺序是否正确
- 确保 `formatOptionsMessage` 函数使用了正确的排序逻辑
- 验证 `createFrameworkFile` 函数中的选项列表顺序

### 4. 内容生成不符合预期

**问题**：生成的内容格式不符合预期或缺少某些部分。

**解决方案**：
- 检查 `generators.ts` 中相应的生成函数是否正确实现
- 确保传入生成函数的配置对象包含所有必要的属性
- 验证模板字符串是否正确构建内容结构

### 5. 选项数量不一致

**问题**：某些工作流提供的选项数量不足6个。

**解决方案**：
- 检查问题工作流的选项构建逻辑
- 确保为已有内容和新建内容都提供了完整的6个选项
- 验证选项数量限制是否被正确应用 